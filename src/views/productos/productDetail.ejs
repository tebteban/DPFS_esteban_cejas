<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title><%= product.name %> - Spikeshop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <style>
    body { font-family: 'Poppins', sans-serif; }

    /* Fondo del modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      max-width: 90%;
      width: 400px;
      text-align: center;
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    .close-modal-btn {
      position: absolute;
      top: 10px; right: 10px;
      background: none; border: none;
      font-size: 1.5rem;
      cursor: pointer; color: #6b7280;
    }
    .close-modal-btn:hover { color: #374151; }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body class="bg-cyan-50">
  <div class="min-h-screen flex flex-col">
    <%- include('../partials/header') %>

    <main class="flex-grow container mx-auto px-4 py-12">
      <a href="/productos" class="flex items-center text-cyan-600 hover:text-cyan-800 transition-colors mb-8">
        <span class="material-icons text-base mr-2">arrow_back</span>
        Volver a productos
      </a>

      <div class="flex flex-col md:flex-row gap-8">
        <!-- Imagen -->
        <div class="md:w-1/2 bg-gray-50 p-6 rounded-lg flex items-center justify-center">
          <img 
            src="<%= product.image && product.image.startsWith('/img/') ? product.image : '/img/products/' + (product.image || 'default.jpg') %>"
            alt="<%= product.name %>"
            class="max-h-96 object-contain rounded-lg border border-gray-200"
            onerror="this.src='/img/products/default.jpg'"
          />
        </div>

        <!-- Info -->
        <div class="md:w-1/2 bg-white p-6 rounded-lg shadow-md">
          <h1 class="text-4xl font-bold text-gray-800 mb-4"><%= product.name %></h1>
          <p class="text-gray-600 text-lg mb-6"><%= product.description %></p>

          <% if (product.category) { %>
            <p class="text-gray-700 mb-2"><strong>Categoría:</strong> <%= product.category.name %></p>
          <% } %>

          <% if (product.brand) { %>
            <p class="text-gray-700 mb-2"><strong>Marca:</strong> <%= product.brand.name %></p>
          <% } %>

          <p class="mt-6 text-3xl font-bold text-cyan-700">$<%= Number(product.price).toFixed(2) %></p>
          <p class="text-gray-500 mt-2">Stock disponible: <%= product.stock %> unidades</p>

          <!-- Botones -->
          <button
            class="mt-6 w-full px-6 py-3 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors text-lg font-semibold add-to-cart-btn"
            data-product-id="<%= product.id %>"
            data-product-name="<%= product.name %>"
            data-product-price="<%= product.price %>"
            data-product-image="<%= product.image && product.image.startsWith('/img/') ? product.image : '/img/products/' + (product.image || 'default.jpg') %>"
          >
            Añadir al carrito
          </button>

          <a href="/productos/editProduct/<%= product.id %>" 
             class="mt-3 w-full inline-block text-center px-6 py-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors text-lg font-semibold">
            Editar Producto
          </a>

          <button id="openDeleteModal"
             class="mt-3 w-full px-6 py-3 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors text-lg font-semibold">
            Eliminar Producto
          </button>
        </div>
      </div>
    </main>

    <%- include('../partials/footer') %>
  </div>

  <!-- MODAL DE CONFIRMACIÓN -->
  <div id="deleteConfirmationModal" class="modal-overlay hidden">
    <div class="modal-content">
      <button class="close-modal-btn" id="closeModalBtn">&times;</button>
      <h3 class="text-2xl font-bold text-gray-800 mb-4">¿Estás seguro de eliminar este producto?</h3>
      <p class="text-lg text-gray-700 mb-4 font-semibold"><%= product.name %></p>

      <% if (product.image) { %>
        <img src="<%= product.image %>" alt="<%= product.name %>" class="w-24 h-24 object-contain mx-auto rounded-md border border-gray-200 p-1 mb-4"/>
      <% } %>

      <div class="flex justify-center space-x-4 mt-6">
        <form action="/productos/deleteProduct/<%= product.id %>" method="POST">
          <button type="submit" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">
            Sí, eliminar
          </button>
        </form>

        <button type="button" id="cancelDeleteButton" class="px-6 py-3 border border-gray-300 rounded-lg shadow-sm text-gray-700 bg-white hover:bg-gray-50 transition-colors">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const addBtn = document.querySelector('.add-to-cart-btn');
      const openModalBtn = document.getElementById('openDeleteModal');
      const modal = document.getElementById('deleteConfirmationModal');
      const cancelBtn = document.getElementById('cancelDeleteButton');
      const closeModalBtn = document.getElementById('closeModalBtn');

      // --- Modal eliminar ---
      if (openModalBtn && modal && cancelBtn && closeModalBtn) {
        openModalBtn.addEventListener('click', () => modal.classList.remove('hidden'));
        cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', e => { if (e.target === modal) modal.classList.add('hidden'); });
      }

      // --- Añadir al carrito ---
      if (addBtn) {
        addBtn.addEventListener('click', e => {
          const productId = e.target.dataset.productId;
          const productName = e.target.dataset.productName;
          const productPrice = parseFloat(e.target.dataset.productPrice);
          const productImage = e.target.dataset.productImage;

          let cart = JSON.parse(localStorage.getItem('cart')) || [];
          const existing = cart.findIndex(item => item.id === productId);

          if (existing > -1) cart[existing].quantity += 1;
          else cart.push({ id: productId, name: productName, price: productPrice, image: productImage, quantity: 1 });

          localStorage.setItem('cart', JSON.stringify(cart));
          alert(`${productName} añadido al carrito.`);
        });
      }
    });
  </script>
</body>
</html>
